<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tisfat ZERO Viewer</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <canvas id="view"></canvas>
    <div><input id="time" type="range" min="0" max="100" step="0.001"></input></div>
    <div><button id="btnPlay">Play</button></div>

    <script src="Util/BinaryReader.js"></script>
    <script src="Util/FileFormat.js"></script>
    <script src="Util/Interpolation.js"></script>
    <script src="Entities/StickFigure.js"></script>
    <script src="Core/Keyframe.js"></script>
    <script src="Core/Frameset.js"></script>
    <script src="Core/Layer.js"></script>
    <script src="Core/Project.js"></script>
    <script>
      (function() {
        "use strict";

        var eView = document.getElementById("view");
        var eTime = document.getElementById("time");
        var eBtnPlay = document.getElementById("btnPlay");

        var project = null;
        var isPlaying = false;
        var playStartFrame = null;
        var playStartTime = null;

        var playFrame = function(time) {
          console.log("hi");
          if (project === null || !isPlaying) {
            console.log("rip");
            return;
          }

          if (playStartTime === null)
            playStartTime = time;

          var frame = playStartFrame + (time - playStartTime) / 1000 * project.fps;
          eTime.value = frame;
          draw();

          if (frame >= project.getEndTime())
            setPlaying(false);
          else
            requestAnimationFrame(playFrame);
        };

        var setPlaying = function(state) {
          if (state) {
            if (!isPlaying)
              requestAnimationFrame(playFrame);

            isPlaying = true;
            playStartTime = null;
            playStartFrame = parseFloat(eTime.value);

            eBtnPlay.textContent = "Pause";
          }
          else {
            isPlaying = false;
            playStartTime = null;
            playStartFrame = null;

            eBtnPlay.textContent = "Play";
          }
        };

        var draw = function() {
          if (project === null)
            return;

          var context = eView.getContext("2d");

          context.fillStyle = TisfatColorToCSS(project.backgroundColor);
          context.fillRect(0, 0, eView.width, eView.height);

          project.draw(context, eTime.value);
        };

        var onProjectLoad = function() {
          eView.width = project.width;
          eView.height = project.height;

          eTime.max = project.getEndTime();
          eTime.value = 0;
          eTime.style.width = project.width + "px";

          draw();
        };

        eBtnPlay.addEventListener("click", function() {
          if (project === null)
            return;

          setPlaying(!isPlaying);
        });

        eTime.addEventListener("input", function() {
          draw();
        });

        var projectReq = new XMLHttpRequest();
        projectReq.responseType = "arraybuffer";

        projectReq.onload = function() {
          var arrayBuffer = projectReq.response;
          if (arrayBuffer && arrayBuffer.byteLength > 0) {
            var reader = new BinaryReader(arrayBuffer, true);
            var version = reader.ReadUInt16();
            project = ReadProject(reader, version);
            onProjectLoad();
          }
        };

        projectReq.open("GET", location.search.substring(1), true);
        projectReq.send();
      })();
    </script>
  </body>
</html>
