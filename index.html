<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tisfat ZERO Viewer</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }

      input[type="range"] {
        margin-left: 0;
        margin-right: 0;
        padding: 0;
        border: 0;
      }

      body {
        color: white;
      }

      a {
        color: #aaaaff;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <noscript>The TISFAT Zero player requires JavaScript support</noscript>
    <div id="textView" style="display:none"></div>
    <div id="mainView" style="display:none">
      <canvas id="view"></canvas>
      <div><input id="time" type="range" min="0" max="100" step="0.00001"></input></div>
      <div><button id="btnPlay">Play</button>&nbsp;&nbsp;&nbsp;&nbsp;<span id="text"></span>&nbsp;&nbsp;&nbsp;&nbsp;<a id="link">Download Project</a></div>
    </div>

    <script src="https://raw.githubusercontent.com/jakearchibald/es6-promise/master/dist/es6-promise.min.js"></script>
    <script src="https://raw.githubusercontent.com/github/fetch/master/fetch.js"></script>
    <script src="Util/BinaryReader.js"></script>
    <script src="Util/FileFormat.js"></script>
    <script src="Util/Interpolation.js"></script>
    <script src="Util/Drawing.js"></script>
    <script src="Entities/StickFigure.js"></script>
    <script src="Entities/RectObject.js"></script>
    <script src="Util/EntityIDs.js"></script>
    <script src="Core/Keyframe.js"></script>
    <script src="Core/Frameset.js"></script>
    <script src="Core/Layer.js"></script>
    <script src="Core/Project.js"></script>
    <script>
      (function() {
        "use strict";

        if (top === self)
          document.body.style.backgroundColor = "black";

        var eTextView = document.getElementById("textView");
        var eMainView = document.getElementById("mainView");

        eTextView.style.display = "block";
        eTextView.textContent = "Initializing player...";

        var eView = document.getElementById("view");
        var eTime = document.getElementById("time");
        var eText = document.getElementById("text");
        var eLink = document.getElementById("link");
        var eBtnPlay = document.getElementById("btnPlay");

        var project = null;
        var isPlaying = false;
        var playStartFrame = null;
        var playStartTime = null;

        var playFrame = function(time) {
          if (!isPlaying)
            return;

          if (playStartTime === null)
            playStartTime = time;

          var frame = playStartFrame + (time - playStartTime) / 1000 * project.fps;
          eTime.value = frame;
          draw();

          if (frame >= project.getEndTime())
            setPlaying(false);
          else
            requestAnimationFrame(playFrame);
        };

        var setPlaying = function(state) {
          if (state) {
            if (!isPlaying)
              requestAnimationFrame(playFrame);

            isPlaying = true;
            playStartTime = null;
            playStartFrame = parseFloat(eTime.value);

            eBtnPlay.textContent = "Pause";
          }
          else {
            isPlaying = false;
            playStartTime = null;
            playStartFrame = null;

            eBtnPlay.textContent = "Play";
          }
        };

        var draw = function() {
          if (project === null)
            return;

          eText.textContent = "Frame " + (Math.floor(eTime.value) + 1) + "/" + (project.getEndTime() + 1);

          var context = eView.getContext("2d");

          context.fillStyle = TisfatColorToCSS(project.backgroundColor);
          context.fillRect(0, 0, eView.width, eView.height);

          project.draw(context, eTime.value);
        };

        var onProjectLoad = function() {
          eTextView.style.display = "none";
          eMainView.style.display = "block";

          eView.width = project.width;
          eView.height = project.height;

          eTime.max = project.getEndTime();
          eTime.value = 0;
          eTime.style.width = project.width + "px";

          draw();
        };

        eBtnPlay.addEventListener("click", function() {
          if (project === null)
            return;

          setPlaying(!isPlaying);
        });

        eTime.addEventListener("input", function() {
          if (isPlaying) {
            playStartTime = null;
            playStartFrame = parseFloat(eTime.value);
          }

          draw();
        });

        eTextView.textContent = "Loading TISFAT Zero project...";
        link.href = location.search.substring(1);

        fetch(link.href).then(function(response) {
          if (!response.ok)
            throw new Error();
          return response.arrayBuffer();
        }).then(function(arrayBuffer) {
          eTextView.textContent = "Parsing TISFAT Zero project...";
          var reader = new BinaryReader(arrayBuffer, true);
          var version = reader.ReadUInt16();
          project = ReadProject(reader, version);
          onProjectLoad();
        }).catch(function(error) {
          console.log(error);
          eTextView.textContent = "Failed to load TISFAT Zero project. Check for bad links, CORS support or a malformed project file.";
        });
      })();
    </script>
  </body>
</html>
